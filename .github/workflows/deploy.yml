name: Deploy Node.js App to EC2 via CodeDeploy

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: ${{ secrets.AWS_REGION }}
      S3_BUCKET: "demo-githubactionsbucket"  # Your existing S3 bucket
      CODEDEPLOY_APP: "test-app"  # Your existing CodeDeploy application
      CODEDEPLOY_GROUP: "test-deployment-group"  # Your existing deployment group
      EC2_USER: "ubuntu"
      SERVER_IP: ${{ secrets.SERVER_PUBLIC_IP }}
      EC2_KEY: ${{ secrets.EC2_KEY }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Set Executable Permissions
        run: |
          echo "ðŸ”§ Setting executable permissions for scripts and appspec..."
          chmod +x appspec.yml
          chmod +x scripts/*.sh

      - name: Create Deployment Package
        run: |
          echo "ðŸ“¦ Creating deployment package..."
          zip -r deploy.zip . -x "*.git*" ".github/*" "*.DS_Store"

      - name: Upload to S3
        run: |
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          S3_KEY="deploy-${TIMESTAMP}.zip"
          echo "ðŸš€ Uploading deployment package to S3: s3://$S3_BUCKET/$S3_KEY"
          
          aws s3 cp deploy.zip s3://$S3_BUCKET/$S3_KEY
          
          echo "S3_KEY=$S3_KEY" >> $GITHUB_ENV

      - name: Set up SSH key for EC2
        run: |
          echo "$EC2_KEY" > ec2_key.pem
          chmod 400 ec2_key.pem

      - name: Run AfterInstall Steps on EC2
        run: |
          echo "ðŸ”§ Running AfterInstall steps directly on EC2..."
          ssh -o StrictHostKeyChecking=no -i ec2_key.pem $EC2_USER@$SERVER_IP << 'EOF'
          set -e  # Exit on error

          echo "ðŸ” Authenticating AWS ECR..."
          aws ecr get-login-password --region ap-south-1 | sudo docker login --username AWS --password-stdin 879381243591.dkr.ecr.ap-south-1.amazonaws.com

          echo "â¬‡ï¸ Pulling latest Docker image..."
          sudo docker pull 879381243591.dkr.ecr.ap-south-1.amazonaws.com/demorepo:latest

          echo "âœ… AfterInstall steps completed!"
          EOF

      - name: Trigger Deployment in CodeDeploy
        run: |
          echo "ðŸš€ Starting deployment in AWS CodeDeploy..."
          
          aws deploy create-deployment \
            --application-name "$CODEDEPLOY_APP" \
            --deployment-group-name "$CODEDEPLOY_GROUP" \
            --s3-location bucket=$S3_BUCKET,key=$S3_KEY,bundleType=zip
